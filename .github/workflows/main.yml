name: RDP via Tailscale
on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 180

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1Ô∏è‚É£ Aktifkan RDP dan firewall
      - name: Enable Remote Desktop
        shell: pwsh
        run: |
          Write-Host "üîß Mengaktifkan RDP dan membuka firewall..."
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Restart-Service -Name TermService -Force
          Write-Host "‚úÖ Remote Desktop sudah aktif."

      # 2Ô∏è‚É£ Buat user dengan password aman (‚â§14 karakter, ASCII khusus dihindari)
      - name: Create Local Admin User
        id: user
        shell: pwsh
        run: |
          $password = -join ((48..57) + (65..90) + (97..122) | Get-Random -Count 12 | ForEach-Object {[char]$_})
          net user RDP $password /add /Y
          net localgroup administrators RDP /add
          Add-Content $env:GITHUB_ENV "RDP_PASSWORD=$password"
          Write-Host "‚úÖ User RDP dibuat: RDP / $password"

      # 3Ô∏è‚É£ Instal Tailscale menggunakan EXE (hindari MSI error)
      - name: Install Tailscale Client
        shell: pwsh
        run: |
          Write-Host "üì¶ Menginstal Tailscale..."
          $exe = "$env:TEMP\tailscale-setup.exe"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile $exe
          Start-Process $exe -ArgumentList "/quiet /norestart" -Wait
          Write-Host "‚úÖ Instalasi Tailscale selesai."

      # 4Ô∏è‚É£ Hubungkan runner ke jaringan Tailscale
      - name: Connect to Tailscale Network
        shell: pwsh
        run: |
          $ts = "C:\Program Files\Tailscale\tailscale.exe"
          $authkey = "${{ secrets.TS_AUTH_KEY }}"
          if ([string]::IsNullOrEmpty($authkey)) {
            Write-Host "‚ö†Ô∏è Auth Key tidak ditemukan! Jalankan login manual..."
            & $ts up --hostname=gh-runner-${{ github.run_id }} --accept-dns=true --accept-routes=true
          } else {
            Write-Host "üîê Menghubungkan node ke Tailnet..."
            & $ts up --auth-key=$authkey --hostname=gh-runner-${{ github.run_id }} --accept-dns=true --accept-routes=true
          }
          if ($LASTEXITCODE -ne 0) { throw "‚ùå Gagal connect ke Tailnet." }
          Write-Host "‚úÖ Node tersambung ke Tailnet."

      # 5Ô∏è‚É£ Tampilkan IP Tailscale dan kredensial akses RDP
      - name: Display Access Information
        shell: pwsh
        run: |
          $ts = "C:\Program Files\Tailscale\tailscale.exe"
          $ip = & $ts ip -4
          Write-Host "`n==============================="
          Write-Host "‚úÖ Tailscale dan RDP Siap Digunakan"
          Write-Host "üåê IP Tailscale: $ip"
          Write-Host "üë§ Username: RDP"
          Write-Host "üîë Password: $env:RDP_PASSWORD"
          Write-Host "Gunakan aplikasi mstsc.exe dengan IP di atas."
          Write-Host "==============================="

      # 6Ô∏è‚É£ Jaga agar sesi tetap hidup selama 12 jam
      - name: Keep Session Alive
        shell: pwsh
        run: |
          Write-Host "üïí Menjaga sesi RDP aktif selama 12 jam (720 menit)..."
          for ($i=0; $i -lt 720; $i++) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Session RDP aktif..."
            Start-Sleep -Seconds 60
          }
