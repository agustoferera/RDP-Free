name: Windows RDP with Tailscale (No MSI, Auto-Working)

on:
  workflow_dispatch:

jobs:
  windows-rdp:
    name: Create Windows RDP Session
    runs-on: windows-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Install Tailscale manually via EXE (bukan MSI)
      - name: Install Tailscale manually
        shell: pwsh
        run: |
          Write-Host "Installing Tailscale using EXE..."
          $installer = "$env:TEMP\tailscale-setup.exe"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile $installer
          Start-Process $installer -ArgumentList "/quiet /norestart" -Wait
          Write-Host "‚úÖ Tailscale installed successfully!"

      # 2. Connect Runner to Tailnet (use Auth Key if available)
      - name: Connect to Tailnet
        shell: pwsh
        run: |
          $tailscale = "C:\Program Files\Tailscale\tailscale.exe"
          $authkey = "${{ secrets.TS_AUTH_KEY }}"

          if ([string]::IsNullOrEmpty($authkey)) {
              Write-Host "No AuthKey provided. Manual login required."
              & $tailscale up --hostname=github-runner --accept-dns=true --accept-routes=true
          } else {
              Write-Host "Using AuthKey to connect to Tailscale."
              & $tailscale up --auth-key=$authkey --hostname=github-runner --accept-dns=true --accept-routes=true
          }

          if ($LASTEXITCODE -ne 0) {
              Write-Error "Tailscale connection failed."
              exit 1
          }

          Write-Host "‚úÖ Connected to Tailscale."

      # 3. Enable RDP + create admin user
      - name: Enable RDP Access
        shell: pwsh
        run: |
          Write-Host "Enabling RDP and configuring firewall..."
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          net user tailscaleuser P@ssw0rd123 /add
          net localgroup administrators tailscaleuser /add
          Write-Host "‚úÖ RDP is now enabled!"

      # 4. Display connection info
      - name: Display Tailscale Connection Info
        shell: pwsh
        run: |
          $tailscale = "C:\Program Files\Tailscale\tailscale.exe"
          $ip = & $tailscale ip -4
          Write-Host "‚úÖ Tailscale connection established!"
          Write-Host "üñ•Ô∏è Connect using:"
          Write-Host "IP Address   : $ip"
          Write-Host "Username     : tailscaleuser"
          Write-Host "Password     : P@ssw0rd123"
          Write-Host "Login via mstsc.exe on your PC."

      # 5. Keep RDP alive for 2 hours
      - name: Keep session alive (2 hours)
        shell: pwsh
        run: |
          Write-Host "‚è≥ Session active for 2 hours for testing..."
          Start-Sleep -Seconds 7200
