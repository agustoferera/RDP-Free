name: Windows RDP with Tailscale (Final Full Version)
on:
  workflow_dispatch:

jobs:
  rdp-job:
    name: Create Secure Windows RDP Session via Tailscale
    runs-on: windows-latest
    timeout-minutes: 180

    steps:
      # 1Ô∏è‚É£ Cek repo agar workflow stabil
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Aktifkan RDP dan firewall
      - name: Enable Remote Desktop Access
        shell: pwsh
        run: |
          Write-Host "Aktifkan RDP dan firewall Windows..."
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Restart-Service -Name TermService -Force
          Write-Host "‚úÖ Remote Desktop aktif dan firewall telah diatur!"

      # 3Ô∏è‚É£ Buat akun RDP admin secara acak
      - name: Create Random Admin Account
        id: user
        shell: pwsh
        run: |
          $chars = (33..126) | ForEach-Object { [char]$_ }
          $password = -join (1..16 | ForEach-Object { Get-Random -InputObject $chars })
          net user GitRDP $password /add
          net localgroup administrators GitRDP /add
          Add-Content $env:GITHUB_ENV "RDP_PASS=$password"
          Write-Host "‚úÖ User created: GitRDP / $password"

      # 4Ô∏è‚É£ Instal Tailscale (pakai EXE, bukan MSI ‚Üí hindari error 1603)
      - name: Install Tailscale (EXE)
        shell: pwsh
        run: |
          Write-Host "Mengunduh dan menginstal Tailscale EXE..."
          $exe = "$env:TEMP\tailscale-setup.exe"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile $exe
          Start-Process $exe -ArgumentList "/quiet /norestart" -Wait
          Write-Host "‚úÖ Tailscale terinstal di $env:ProgramFiles."

      # 5Ô∏è‚É£ Hubungkan ke jaringan Tailscale (pakai Auth Key)
      - name: Connect to Tailnet
        shell: pwsh
        run: |
          $tailscale = "C:\Program Files\Tailscale\tailscale.exe"
          $authkey = "${{ secrets.TS_AUTH_KEY }}"
          if ([string]::IsNullOrEmpty($authkey)) {
            Write-Host "‚ö†Ô∏è Tidak ada Auth Key, jalankan login manual lewat browser."
            & $tailscale up --hostname=rdp-${{ github.run_id }} --accept-dns=true --accept-routes=true
          } else {
            Write-Host "üîê Menghubungkan ke Tailscale dengan Auth Key..."
            & $tailscale up --auth-key=$authkey --hostname=rdp-${{ github.run_id }} --accept-dns=true --accept-routes=true
          }
          if ($LASTEXITCODE -ne 0) { throw "‚ùå Gagal konek ke Tailnet." }
          Write-Host "‚úÖ Berhasil tersambung ke Tailnet!"

      # 6Ô∏è‚É£ Tampilkan IP dan kredensial RDP
      - name: Display Connection Info
        shell: pwsh
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "`n========================================"
          Write-Host "‚úÖ RDP Connected Successfully"
          Write-Host "üåê IP Address (Tailscale): $ip"
          Write-Host "üë§ Username: GitRDP"
          Write-Host "üîë Password: $env:RDP_PASS"
          Write-Host "‚öôÔ∏è Jalankan: mstsc.exe ‚Üí Masukkan IP & akun di atas."
          Write-Host "========================================`n"

      # 7Ô∏è‚É£ Pastikan Tailscale tetap aktif dan RDP terjaga
      - name: Keep RDP Session Alive (2 Hours)
        shell: pwsh
        run: |
          Write-Host "‚öôÔ∏è Menjaga RDP aktif selama 2 jam..."
          for ($i=0; $i -lt 120; $i++) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP aktif..."
            Start-Sleep -Seconds 60
          }
